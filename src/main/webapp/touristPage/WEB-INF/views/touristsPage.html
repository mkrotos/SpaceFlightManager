<!DOCTYPE html>
<html>
<head>
    <title>Space Flight Manager - tourists manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
</head>
<body>
<div class="navbar">
    <div class="navbar-inner">
        <a class="brand" href="#">Space Flight Manager - tourists manager</a>
    </div>
</div>

<!-- Tourist table-->
<div id="main" class="container">
    <table class="table table-striped">
        <tr>
            <td style="width: 1px;"><b>Id</b></td>
            <td><b>Name</b></td>
            <td><b>Surname</b></td>
            <td><b>Options</b></td>
        </tr>
        <!-- ko foreach: tasks -->
        <tr>

            <td><p><b data-bind="text: id"></b></p></td>
            <td><p><b data-bind="text: name"></b></p></td>
            <td><p><b data-bind="text: surname"></b></p></td>
            <td>
                <button data-bind="click: $parent.beginEdit" class="btn">Edit</button>
                <button data-bind="click: $parent.remove" class="btn">Delete</button>
            </td>
        </tr>
        <!-- /ko -->
    </table>
    <button data-bind="click: beginAdd" class="btn">Add Task</button>
</div>

<!-- Add tourist form-->
<div id="add" class="modal hide fade" tabindex="=1" role="dialog" aria-labelledby="addDialogLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
        <h3 id="addDialogLabel">Add Task</h3>
    </div>
    <div class="modal-body">
        <form class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="inputTask">Task</label>
                <div class="controls">
                    <input data-bind="value: title" type="text" id="inputTask" placeholder="Task title"
                           style="width: 150px;">
                </div>
            </div>
            <div class="control-group">
                <label class="control-label" for="inputDescription">Description</label>
                <div class="controls">
                    <input data-bind="value: description" type="text" id="inputDescription" placeholder="Description"
                           style="width: 300px;">
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button data-bind="click: addTask" class="btn btn-primary">Add Task</button>
        <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
    </div>


    <script type="text/javascript">
        function TasksViewModel() {
            var self = this;
            self.tasksURI = 'http://localhost:8080/tourists/';

            self.tasks = ko.observableArray();

            self.ajax = function (uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: JSON.stringify(data),
                    error: function (jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }

            self.beginAdd = function () {
                $('#add').modal('show');
            }
            self.beginEdit = function (task) {
                alert("Edit: " + task.title());
            }
            self.remove = function (task) {
                alert("Remove: " + task.title());
            }
            self.markInProgress = function (task) {
                task.done(false);
            }
            self.markDone = function (task) {
                task.done(true);
            }

            self.ajax(self.tasksURI, 'GET').done(function (data) {
                for (var i = 0; i < data.tasks.length; i++) {
                    self.tasks.push({
                        uri: ko.observable(data.tasks[i].uri),
                        id: ko.observable(data.tasks[i].id),
                        name: ko.observable(data.tasks[i].name),
                        surname: ko.observable(data.tasks[i].surname),
                        done: ko.observable(data.tasks[i].done)
                    });
                }
            });

            self.add = function (task) {
                self.ajax(self.tasksURI, 'POST', task).done(function (data) {
                    self.tasks.push({
                        uri: ko.observable(data.task.uri),
                        title: ko.observable(data.task.title),
                        description: ko.observable(data.task.description),
                        done: ko.observable(data.task.done)
                    });
                });
            }
        }

        function AddTaskViewModel() {
            var self = this;
            self.title = ko.observable();
            self.description = ko.observable();

            self.addTask = function () {
                $('#add').modal('hide');
                tasksViewModel.add({
                    title: self.title(),
                    description: self.description()
                });
                self.title("");
                self.description("");
            }

        }

        var tasksViewModel = new TasksViewModel();
        var addTaskViewModel = new AddTaskViewModel();
        ko.applyBindings(tasksViewModel, $('#main')[0]);
        ko.applyBindings(addTaskViewModel, $('#add')[0]);
    </script>

</body>
</html>